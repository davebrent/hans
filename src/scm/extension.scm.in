;; # vim: set filetype=scheme:

(define-module (hans extension)
  :export (hans-load-extension
           hans-plugin-path
           PLUGIN-PATH
           CMAKE-LIBRARY-OUTPUT-DIRECTORY
           CMAKE-INSTALL-PREFIX))

(define CMAKE-LIBRARY-OUTPUT-DIRECTORY "@CMAKE_LIBRARY_OUTPUT_DIRECTORY@")
(define CMAKE-INSTALL-PREFIX "@CMAKE_INSTALL_PREFIX@")
(define PLUGIN-PATH "@SCM_OUTPUT_DIRECTORY@/plugin")

(define (hans-plugin-path name)
  (string-append PLUGIN-PATH "/" name))

(define (hans-load-extension lib init)
  ;; Load `lib` falling back to other paths if it fails
  (define (load-extension-inner libs)
    (catch 'misc-error
           (lambda ()
             (load-extension (car libs) init))
           (lambda (key . parameters)
             (if (not (null? (cdr libs)))
               (load-extension-inner (cdr libs))
               ;; Search paths exhausted, trigger the original error
               (load-extension lib init)))))
  (load-extension-inner
    `(,lib
      ,(string-append CMAKE-LIBRARY-OUTPUT-DIRECTORY "/" lib)
      ,(string-append CMAKE-INSTALL-PREFIX "/lib/" lib))))
